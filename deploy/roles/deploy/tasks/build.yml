# All project build tasks go here. These tasks will only be run for the
# specified commit if the commit hasn't been deployed before or if "force"
# is true.

# install npm packages
# install composer packages

# Modify as-needed!

- name: install php modules
  composer:
    command: install
    working_dir: "{{ clone_path }}"

- name: install npm modules
  npm:
    path: "{{ clone_path }}"
    ci: yes

- name: build production version
  command: npm run build
  args:
    chdir: "{{ clone_path }}"
  environment:
    NODE_ENV: production
  when: force or not sha_dir.stat.exists

- name: ensure admin account directory structure exists
  file:
    path: "{{ clone_path }}/site/accounts/{{ item.path }}"
    state: directory
    owner: www-data
    group: www-data
  with_filetree: "../templates/accounts/"
  when: item.state == 'directory'

- name: ensure admin account files are populated from templates
  template:
    src: "{{ item.src }}"
    dest: "{{ clone_path }}/site/accounts/{{ item.path | regex_replace('\\.j2$', '') }}"
    owner: www-data
    group: www-data
  with_filetree: "../templates/accounts/"
  when: item.state == 'file'

- name: generate build info file
  template: src=build_info.txt.j2 dest={{ clone_path }}/{{ build_info_path }}
  when: build_info_path is defined
